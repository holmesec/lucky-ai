name: Train + Deploy (manual)

on:
  workflow_dispatch:
    inputs:
      max_epochs:
        description: "Max epochs"
        required: true
        default: "1"
      lr:
        description: "Learning rate"
        required: true
        default: "2e-5"
      batch_size:
        description: "Batch size"
        required: true
        default: "64"

      rebuild_train_image:
        description: "Rebuild training image?"
        required: true
        default: "false"
      train_image_tag:
        description: "Training image tag to use when not rebuilding (e.g. stable)"
        required: true
        default: "stable"

jobs:
  train_and_deploy:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: dtumlops-484507
      REGION: europe-west1
      AR_REPO: lucky-ai-repo

      TRAIN_IMAGE: train-image
      API_IMAGE: api-image

      CLOUD_RUN_SERVICE: lucky-ai-api

      WANDB_ENTITY: lucky_ai
      WANDB_PROJECT: lucky-ai

      DATA_PATH: /gcs/lucky_ai/data/processed
      NUM_WORKERS: "4"

    steps:
      - uses: actions/checkout@v4

      - name: Auth to GCP
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCLOUD_SERVICE_KEY_MLOPS }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v3

      # Decide tags for this run
      - name: Set run variables
        id: vars
        run: |
          RUN_TAG="${GITHUB_SHA::7}"
          echo "run_tag=${RUN_TAG}" >> $GITHUB_OUTPUT

          if [ "${{ inputs.rebuild_train_image }}" = "true" ]; then
            echo "train_image_tag=${RUN_TAG}" >> $GITHUB_OUTPUT
          else
            echo "train_image_tag=${{ inputs.train_image_tag }}" >> $GITHUB_OUTPUT
          fi

          echo "model_alias=sha-${RUN_TAG}" >> $GITHUB_OUTPUT

      # -------- Build training image (optional) --------
      - name: Build training image in Cloud Build (optional)
        if: ${{ inputs.rebuild_train_image == 'true' }}
        run: |
          TAG="${{ steps.vars.outputs.run_tag }}"
          echo "Building training image tag: ${TAG}"
          gcloud builds submit . \
            --project "${PROJECT_ID}" \
            --config cloudbuild.yaml \
            --substitutions=_TAG="${TAG}"

      # -------- Render Vertex job config and submit training job --------
      - name: Render Vertex job config (envsubst)
        run: |
          sudo apt-get update && sudo apt-get install -y gettext-base
          export PROJECT_ID="${PROJECT_ID}"
          export TRAIN_IMAGE_TAG="${{ steps.vars.outputs.train_image_tag }}"
          export WANDB_API_KEY="${{ secrets.WANDB_API_KEY }}"
          export MAX_EPOCHS="${{ inputs.max_epochs }}"
          export LR="${{ inputs.lr }}"
          export BATCH_SIZE="${{ inputs.batch_size }}"
          export NUM_WORKERS="${NUM_WORKERS}"
          export DATA_PATH="${DATA_PATH}"
          export MODEL_ALIAS="${{ steps.vars.outputs.model_alias }}"
          envsubst < custom_job_TEMPLATE.yaml > custom_job.yaml

      - name: Submit Vertex Custom Job
        id: submit
        run: |
          JOB_NAME="lucky-ai-train-${{ steps.vars.outputs.run_tag }}"
          JOB_ID=$(gcloud ai custom-jobs create \
            --project "${PROJECT_ID}" \
            --region "${REGION}" \
            --display-name "${JOB_NAME}" \
            --config custom_job.yaml \
            --format="value(name)")
          echo "job_id=${JOB_ID}" >> $GITHUB_OUTPUT
          echo "Submitted job: ${JOB_ID}"

      # -------- Poll until training finishes --------
      - name: Wait for Vertex training to finish
        run: |
          JOB_ID="${{ steps.submit.outputs.job_id }}"
          echo "Polling: ${JOB_ID}"
          for i in $(seq 1 180); do
            STATE=$(gcloud ai custom-jobs describe "${JOB_ID}" --region "${REGION}" --format="value(state)")
            echo "State: ${STATE}"
            if [ "${STATE}" = "JOB_STATE_SUCCEEDED" ]; then
              echo "Training succeeded."
              exit 0
            fi
            if [ "${STATE}" = "JOB_STATE_FAILED" ] || [ "${STATE}" = "JOB_STATE_CANCELLED" ]; then
              echo "Training did not succeed."
              exit 1
            fi
            sleep 60
          done
          echo "Timed out waiting for training."
          exit 1

      # -------- Build API image that bakes in THIS runâ€™s model --------
      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Build + push API image (bake trained model)
        env:
          WANDB_API_KEY: ${{ secrets.WANDB_API_KEY }}
          WANDB_ENTITY: ${{ env.WANDB_ENTITY }}
          WANDB_PROJECT: ${{ env.WANDB_PROJECT }}
        run: |
          RUN_TAG="${{ steps.vars.outputs.run_tag }}"
          ARTIFACT="lucky_ai/lucky-ai/lucky_bert:${{ steps.vars.outputs.model_alias }}"
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/${API_IMAGE}:${RUN_TAG}"

          echo "Baking artifact: ${ARTIFACT}"
          export DOCKER_BUILDKIT=1

          docker build \
            -f dockerfiles/api.dockerfile \
            --build-arg WANDB_ARTIFACT="${ARTIFACT}" \
            --secret id=WANDB_API_KEY,env=WANDB_API_KEY \
            --secret id=WANDB_ENTITY,env=WANDB_ENTITY \
            --secret id=WANDB_PROJECT,env=WANDB_PROJECT \
            -t "${IMAGE}" \
            .

          docker push "${IMAGE}"
          echo "Pushed API image: ${IMAGE}"

      # -------- Deploy to Cloud Run --------
      - name: Deploy API to Cloud Run
        run: |
          RUN_TAG="${{ steps.vars.outputs.run_tag }}"
          IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${AR_REPO}/${API_IMAGE}:${RUN_TAG}"

          gcloud run deploy "${CLOUD_RUN_SERVICE}" \
            --image "${IMAGE}" \
            --region "${REGION}" \
            --platform managed \
            --allow-unauthenticated \
            --memory 4Gi \
            --cpu 2 \
            --timeout 300
